<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Tutorial 8: Threshold Autoregression | Forecasting With Time Series Models Using R" />
<meta property="og:type" content="book" />
<meta property="og:image" content="/forecasting-logo.png" />
<meta property="og:description" content="Tutorial 8: Threshold Autoregression | Forecasting With Time Series Models Using R" />


<meta name="author" content="David Ubilava" />


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<meta name="description" content="Tutorial 8: Threshold Autoregression | Forecasting With Time Series Models Using R">

<title>Tutorial 8: Threshold Autoregression | Forecasting With Time Series Models Using R</title>

<link href="libs/tufte-css-2015.12.29/tufte.css" rel="stylesheet" />
<link href="libs/tufte-css-2015.12.29/envisioned.css" rel="stylesheet" />
<link href="libs/msmb-css-0/msmb.css" rel="stylesheet" />
<script>
function toggle_visibility(id1, id2) {
var e = document.getElementById(id1);
var f = document.getElementById(id2);

e.style.display = ((e.style.display!='none') ? 'none' : 'block');

if(f.classList.contains('fa-plus-square')) {
    f.classList.add('fa-minus-square')
    f.classList.remove('fa-plus-square')
} else {
    f.classList.add('fa-plus-square')
    f.classList.remove('fa-minus-square')
}

}
</script>
<script>
function copy_link(id) {
  var dummy = document.createElement('input'),
  text = window.location.href.split(/[?#]/)[0] + '#' + id;
  document.body.appendChild(dummy);
  dummy.value = text;
  dummy.select();
  document.execCommand('copy');
  document.body.removeChild(dummy);
  
  var tooltip = document.getElementById(id + '-tooltip');
  tooltip.innerHTML = 'Copied!';
}

function reset_tooltip(id) {
  var tooltip = document.getElementById(id);
  tooltip.innerHTML = 'Copy link';
}
</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
<script>
  $(document).ready(function () {
    var element_label= $("label[for *= 'tufte-sn-']");
    var count = $(element_label).length;
    $(element_label).each(function( index ) {
      //console.log( ++index + ": " + $( this ).text() );
      $(this).attr('for','tufte-sn-'+ ++index);
      $(this).text(index);
    });
  });
  $(document).ready(function () {
    var element_input= $("input[id *= 'tufte-sn-']");
    var count = $(element_input).length;
    $(element_input).each(function( index ) {
      //console.log( ++index + ": " + $( this ).text() );
      $(this).attr('id','tufte-sn-'+ ++index);
    }); 
  });
  $(document).ready(function () {
    var element_span= $("span[class *= 'sidenote-number']");
    var count = $(element_span).length;
    $(element_span).each(function( index ) {
      //console.log( ++index + ": " + $( this ).text() );
      $(this).text(++index);
    }); 
  });
</script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }

code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>



<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul class="navbar">
<li class="msmb"><p class="title">Forecasting With Time Series Models Using R<p><p class="author">David Ubilava</p>
<li class="dropdown" style="float:right">
<a href="javascript:void(0)" class="dropbtn">&#x25BE; Chapters</a>
<div class="dropdown-content">
<a href="index.html" id="toc-foreword">Foreword</a>
<a href="forecasting-with-time-series-models.html" id="toc-forecasting-with-time-series-models">Forecasting With Time Series Models</a>
<a href="introduction-to-forecasting.html" id="toc-introduction-to-forecasting"><span class="toc-section-number">1</span> Introduction to Forecasting</a>
<a href="features-of-time-series-data.html" id="toc-features-of-time-series-data"><span class="toc-section-number">2</span> Features of Time Series Data</a>
<a href="forecasting-methods-and-routines.html" id="toc-forecasting-methods-and-routines"><span class="toc-section-number">3</span> Forecasting Methods and Routines</a>
<a href="trends.html" id="toc-trends"><span class="toc-section-number">4</span> Trends</a>
<a href="seasonality.html" id="toc-seasonality"><span class="toc-section-number">5</span> Seasonality</a>
<a href="autoregression.html" id="toc-autoregression"><span class="toc-section-number">6</span> Autoregression</a>
<a href="vector-autoregressive-models.html" id="toc-vector-autoregressive-models"><span class="toc-section-number">7</span> Vector Autoregressive Models</a>
<a href="dynamic-factor-models.html" id="toc-dynamic-factor-models"><span class="toc-section-number">8</span> Dynamic Factor Models</a>
<a href="threshold-autoregressive-models.html" id="toc-threshold-autoregressive-models"><span class="toc-section-number">9</span> Threshold Autoregressive Models</a>
<a href="forecast-evaluation.html" id="toc-forecast-evaluation"><span class="toc-section-number">10</span> Forecast Evaluation</a>
<a href="forecast-combination.html" id="toc-forecast-combination"><span class="toc-section-number">11</span> Forecast Combination</a>
<a href="forecasting-using-r.html" id="toc-forecasting-using-r">Forecasting Using R</a>
<a href="tutorial-1-introduction-to-r.html" id="toc-tutorial-1-introduction-to-r">Tutorial 1: Introduction to R</a>
<a href="tutorial-2-data-management-and-visualisation.html" id="toc-tutorial-2-data-management-and-visualisation">Tutorial 2: Data Management and Visualisation</a>
<a href="tutorial-3-forecasting-methods-and-routines.html" id="toc-tutorial-3-forecasting-methods-and-routines">Tutorial 3: Forecasting Methods and Routines</a>
<a href="tutorial-4-trends-and-seasonality.html" id="toc-tutorial-4-trends-and-seasonality">Tutorial 4: Trends and Seasonality</a>
<a href="tutorial-5-autoregressive-models.html" id="toc-tutorial-5-autoregressive-models">Tutorial 5: Autoregressive Models</a>
<a href="tutorial-6-vector-autoregressive-models.html" id="toc-tutorial-6-vector-autoregressive-models">Tutorial 6: Vector Autoregressive Models</a>
<a href="tutorial-7-dynamic-factor-models.html" id="toc-tutorial-7-dynamic-factor-models">Tutorial 7: Dynamic Factor Models</a>
<a id="active-page" href="tutorial-8-threshold-autoregression.html" id="toc-tutorial-8-threshold-autoregression">Tutorial 8: Threshold Autoregression</a>
<a href="tutorial-9-forecast-evaluation.html" id="toc-tutorial-9-forecast-evaluation">Tutorial 9: Forecast Evaluation</a>
<a href="tutorial-10-forecast-combination.html" id="toc-tutorial-10-forecast-combination">Tutorial 10: Forecast Combination</a>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="tutorial-8-threshold-autoregression" class="section level1 unnumbered">
<h1>Tutorial 8: Threshold Autoregression</h1>
<p>(this is a threshold stuff, will need to move back)</p>
<p>In this tutorial, we will generate regime-dependent series, we will apply a grid-search method to obtain the threshold parameter, we will obtain and compare one-step-ahead forecasts from competing models using a rolling window procedure, and we will apply bootstrap resampling method to generate multi-step-ahead forecasts from a threshold regression. To run the code, the <code>data.table</code> and <code>ggplot2</code> packages need to be installed and loaded.</p>
<p>Let’s generate a time series that follow a TAR(2) process of the following form:
<!-- $$y_t = \left\{\begin{array} -->
<!-- {ll} -->
<!-- y_{t-1} + \varepsilon_t & \text{if}~~y_{t-1}\ge0 \\ -->
<!-- 1.2y_{t-1}-0.3y_{t-2} + \varepsilon_t & \text{if}~~y_{t-1} < 0 -->
<!-- \end{array}\right. -->
<!-- $$ -->
where <span class="math inline">\(e_{t} \sim N(0,\sigma^2)\)</span>. This suggests that the time series follow the unit root process if the lagged dependent variable is non-negative, otherwise the time series is a mean-reverting AR(2) process.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb107-1"><a href="tutorial-8-threshold-autoregression.html#cb107-1" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">360</span></span>
<span id="cb107-2"><a href="tutorial-8-threshold-autoregression.html#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="tutorial-8-threshold-autoregression.html#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">6</span>)</span>
<span id="cb107-4"><a href="tutorial-8-threshold-autoregression.html#cb107-4" aria-hidden="true" tabindex="-1"></a>e <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n,<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb107-5"><a href="tutorial-8-threshold-autoregression.html#cb107-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-6"><a href="tutorial-8-threshold-autoregression.html#cb107-6" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>,n)</span>
<span id="cb107-7"><a href="tutorial-8-threshold-autoregression.html#cb107-7" aria-hidden="true" tabindex="-1"></a>y[<span class="dv">1</span>] <span class="ot">&lt;-</span> e[<span class="dv">1</span>]</span>
<span id="cb107-8"><a href="tutorial-8-threshold-autoregression.html#cb107-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(y[<span class="dv">1</span>]<span class="sc">&gt;=</span><span class="dv">0</span>){</span>
<span id="cb107-9"><a href="tutorial-8-threshold-autoregression.html#cb107-9" aria-hidden="true" tabindex="-1"></a>  y[<span class="dv">2</span>] <span class="ot">&lt;-</span>  <span class="fl">1.0</span><span class="sc">*</span>y[<span class="dv">1</span>]<span class="sc">+</span>e[<span class="dv">2</span>]</span>
<span id="cb107-10"><a href="tutorial-8-threshold-autoregression.html#cb107-10" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb107-11"><a href="tutorial-8-threshold-autoregression.html#cb107-11" aria-hidden="true" tabindex="-1"></a>  y[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fl">1.2</span><span class="sc">*</span>y[<span class="dv">1</span>]<span class="sc">+</span>e[<span class="dv">2</span>]</span>
<span id="cb107-12"><a href="tutorial-8-threshold-autoregression.html#cb107-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb107-13"><a href="tutorial-8-threshold-autoregression.html#cb107-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-14"><a href="tutorial-8-threshold-autoregression.html#cb107-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">3</span><span class="sc">:</span>n){</span>
<span id="cb107-15"><a href="tutorial-8-threshold-autoregression.html#cb107-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(y[i<span class="dv">-1</span>]<span class="sc">&gt;=</span><span class="dv">0</span>){</span>
<span id="cb107-16"><a href="tutorial-8-threshold-autoregression.html#cb107-16" aria-hidden="true" tabindex="-1"></a>    y[i] <span class="ot">&lt;-</span>  <span class="fl">1.0</span><span class="sc">*</span>y[i<span class="dv">-1</span>]<span class="sc">+</span>e[i]</span>
<span id="cb107-17"><a href="tutorial-8-threshold-autoregression.html#cb107-17" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb107-18"><a href="tutorial-8-threshold-autoregression.html#cb107-18" aria-hidden="true" tabindex="-1"></a>    y[i] <span class="ot">&lt;-</span> <span class="fl">1.2</span><span class="sc">*</span>y[i<span class="dv">-1</span>]<span class="sc">-</span><span class="fl">0.3</span><span class="sc">*</span>y[i<span class="dv">-2</span>]<span class="sc">+</span>e[i]</span>
<span id="cb107-19"><a href="tutorial-8-threshold-autoregression.html#cb107-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb107-20"><a href="tutorial-8-threshold-autoregression.html#cb107-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Generate a vector of some arbitrary dates (e.g., suppose we deal with the monthly series beginning from January 1991), and store these along with <span class="math inline">\(y\)</span> in a <strong>data.table</strong>, call it ‘dt’.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="tutorial-8-threshold-autoregression.html#cb108-1" aria-hidden="true" tabindex="-1"></a>date <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"1991-01-01"</span>),<span class="at">by=</span><span class="st">"month"</span>,<span class="at">along.with=</span>y)</span>
<span id="cb108-2"><a href="tutorial-8-threshold-autoregression.html#cb108-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-3"><a href="tutorial-8-threshold-autoregression.html#cb108-3" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(date,y)</span></code></pre></div>
<p>Plot the realized time series using <strong>ggplot</strong> function.</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb109-1"><a href="tutorial-8-threshold-autoregression.html#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dt,<span class="fu">aes</span>(<span class="at">x=</span>date,<span class="at">y=</span>y))<span class="sc">+</span></span>
<span id="cb109-2"><a href="tutorial-8-threshold-autoregression.html#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size=</span><span class="dv">1</span>)<span class="sc">+</span></span>
<span id="cb109-3"><a href="tutorial-8-threshold-autoregression.html#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Series"</span>)<span class="sc">+</span></span>
<span id="cb109-4"><a href="tutorial-8-threshold-autoregression.html#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code></pre></div>
<p><img src="forecasting_files/figure-html/unnamed-chunk-78-1.png" width="624"></p>
<p>Decide on the optimal lag length based on AIC.</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="tutorial-8-threshold-autoregression.html#cb110-1" aria-hidden="true" tabindex="-1"></a>dt[,<span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">y_l1=</span><span class="fu">shift</span>(y),<span class="at">y_l2=</span><span class="fu">shift</span>(y,<span class="dv">2</span>),<span class="at">y_l3=</span><span class="fu">shift</span>(y,<span class="dv">3</span>),<span class="at">y_l4=</span><span class="fu">shift</span>(y,<span class="dv">4</span>))]</span>
<span id="cb110-2"><a href="tutorial-8-threshold-autoregression.html#cb110-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> dt[<span class="fu">complete.cases</span>(dt)]</span>
<span id="cb110-3"><a href="tutorial-8-threshold-autoregression.html#cb110-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-4"><a href="tutorial-8-threshold-autoregression.html#cb110-4" aria-hidden="true" tabindex="-1"></a>IC_dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">lag=</span><span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>),<span class="at">AIC=</span><span class="fu">as.numeric</span>(<span class="cn">NA</span>),<span class="at">SIC=</span><span class="fu">as.numeric</span>(<span class="cn">NA</span>))</span>
<span id="cb110-5"><a href="tutorial-8-threshold-autoregression.html#cb110-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-6"><a href="tutorial-8-threshold-autoregression.html#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(IC_dt)){</span>
<span id="cb110-7"><a href="tutorial-8-threshold-autoregression.html#cb110-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-8"><a href="tutorial-8-threshold-autoregression.html#cb110-8" aria-hidden="true" tabindex="-1"></a>  fmla <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"y"</span>,<span class="fu">paste0</span>(<span class="st">"y_l"</span>,<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span>i),<span class="at">collapse=</span><span class="st">"+"</span>),<span class="at">sep=</span><span class="st">"~"</span>))</span>
<span id="cb110-9"><a href="tutorial-8-threshold-autoregression.html#cb110-9" aria-hidden="true" tabindex="-1"></a>  reg.ar <span class="ot">&lt;-</span> <span class="fu">lm</span>(fmla,<span class="at">data=</span>dt)</span>
<span id="cb110-10"><a href="tutorial-8-threshold-autoregression.html#cb110-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb110-11"><a href="tutorial-8-threshold-autoregression.html#cb110-11" aria-hidden="true" tabindex="-1"></a>  IC_dt<span class="sc">$</span>AIC[i] <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">crossprod</span>(reg.ar<span class="sc">$</span>residuals))<span class="sc">+</span><span class="dv">2</span><span class="sc">*</span>(i<span class="sc">+</span><span class="dv">1</span>)<span class="sc">/</span><span class="fu">nrow</span>(dt)</span>
<span id="cb110-12"><a href="tutorial-8-threshold-autoregression.html#cb110-12" aria-hidden="true" tabindex="-1"></a>  IC_dt<span class="sc">$</span>SIC[i] <span class="ot">&lt;-</span> <span class="fu">log</span>(<span class="fu">crossprod</span>(reg.ar<span class="sc">$</span>residuals))<span class="sc">+</span><span class="fu">log</span>(<span class="fu">nrow</span>(dt))<span class="sc">*</span>(i<span class="sc">+</span><span class="dv">1</span>)<span class="sc">/</span><span class="fu">nrow</span>(dt)</span>
<span id="cb110-13"><a href="tutorial-8-threshold-autoregression.html#cb110-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-14"><a href="tutorial-8-threshold-autoregression.html#cb110-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb110-15"><a href="tutorial-8-threshold-autoregression.html#cb110-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-16"><a href="tutorial-8-threshold-autoregression.html#cb110-16" aria-hidden="true" tabindex="-1"></a>IC_dt</span></code></pre></div>
<pre><code>##    lag      AIC      SIC
## 1:   1 5.822589 5.844358
## 2:   2 5.821342 5.853996
## 3:   3 5.826916 5.870454
## 4:   4 5.832294 5.886717</code></pre>
<p>We now need to get an estimate of the threshold parameter (i.e., the value at which the switch between the regimes happens). For that, we perform a grid-search routine. We will consider a range of candidate thresholds that are within 10th and 90th percentile of the lagged dependent variable. For each candidate threshold, we will run an OLS and calculate the residual sums of squares. A threshold that yields the lowest residual sum of squares will be the estimate.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="tutorial-8-threshold-autoregression.html#cb112-1" aria-hidden="true" tabindex="-1"></a>qy <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">quantile</span>(dt<span class="sc">$</span>y,<span class="fu">c</span>(.<span class="dv">1</span>,.<span class="dv">9</span>)),<span class="dv">1</span>)</span>
<span id="cb112-2"><a href="tutorial-8-threshold-autoregression.html#cb112-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-3"><a href="tutorial-8-threshold-autoregression.html#cb112-3" aria-hidden="true" tabindex="-1"></a>tr <span class="ot">&lt;-</span> <span class="fu">seq</span>(qy[<span class="dv">1</span>],qy[<span class="dv">2</span>],<span class="at">by=</span>.<span class="dv">1</span>)</span>
<span id="cb112-4"><a href="tutorial-8-threshold-autoregression.html#cb112-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-5"><a href="tutorial-8-threshold-autoregression.html#cb112-5" aria-hidden="true" tabindex="-1"></a>grid_dt <span class="ot">&lt;-</span> <span class="fu">data.table</span>(tr,<span class="at">ssr=</span><span class="cn">NA</span>)</span>
<span id="cb112-6"><a href="tutorial-8-threshold-autoregression.html#cb112-6" aria-hidden="true" tabindex="-1"></a>grid_dt[,<span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">ssr=</span><span class="fu">as.numeric</span>(ssr))]</span>
<span id="cb112-7"><a href="tutorial-8-threshold-autoregression.html#cb112-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-8"><a href="tutorial-8-threshold-autoregression.html#cb112-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> tr){</span>
<span id="cb112-9"><a href="tutorial-8-threshold-autoregression.html#cb112-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb112-10"><a href="tutorial-8-threshold-autoregression.html#cb112-10" aria-hidden="true" tabindex="-1"></a>  dt[,<span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">d=</span><span class="fu">ifelse</span>(y_l1<span class="sc">&gt;=</span>i,<span class="dv">1</span>,<span class="dv">0</span>))]</span>
<span id="cb112-11"><a href="tutorial-8-threshold-autoregression.html#cb112-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb112-12"><a href="tutorial-8-threshold-autoregression.html#cb112-12" aria-hidden="true" tabindex="-1"></a>  tar <span class="ot">&lt;-</span> <span class="fu">lm</span>(y<span class="sc">~</span>(y_l1<span class="sc">+</span>y_l2)<span class="sc">:</span><span class="fu">I</span>(d)<span class="sc">+</span>(y_l1<span class="sc">+</span>y_l2)<span class="sc">:</span><span class="fu">I</span>(<span class="dv">1</span><span class="sc">-</span>d),<span class="at">data=</span>dt)</span>
<span id="cb112-13"><a href="tutorial-8-threshold-autoregression.html#cb112-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb112-14"><a href="tutorial-8-threshold-autoregression.html#cb112-14" aria-hidden="true" tabindex="-1"></a>  grid_dt[tr<span class="sc">==</span>i]<span class="sc">$</span>ssr <span class="ot">&lt;-</span> <span class="fu">crossprod</span>(tar<span class="sc">$</span>residuals)</span>
<span id="cb112-15"><a href="tutorial-8-threshold-autoregression.html#cb112-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb112-16"><a href="tutorial-8-threshold-autoregression.html#cb112-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb112-17"><a href="tutorial-8-threshold-autoregression.html#cb112-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-18"><a href="tutorial-8-threshold-autoregression.html#cb112-18" aria-hidden="true" tabindex="-1"></a>tr_hat <span class="ot">&lt;-</span> grid_dt[ssr<span class="sc">==</span><span class="fu">min</span>(ssr)]<span class="sc">$</span>tr</span>
<span id="cb112-19"><a href="tutorial-8-threshold-autoregression.html#cb112-19" aria-hidden="true" tabindex="-1"></a>tr_hat</span></code></pre></div>
<pre><code>## [1] -1</code></pre>
<p>Estimate the threshold autoregression and compare the parameter estimates with the true parameters of the model.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb114-1"><a href="tutorial-8-threshold-autoregression.html#cb114-1" aria-hidden="true" tabindex="-1"></a>dt[,<span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">d=</span><span class="fu">ifelse</span>(y_l1<span class="sc">&gt;=</span>tr_hat,<span class="dv">1</span>,<span class="dv">0</span>))]</span>
<span id="cb114-2"><a href="tutorial-8-threshold-autoregression.html#cb114-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-3"><a href="tutorial-8-threshold-autoregression.html#cb114-3" aria-hidden="true" tabindex="-1"></a>tar <span class="ot">&lt;-</span> <span class="fu">lm</span>(y<span class="sc">~</span>(y_l1<span class="sc">+</span>y_l2)<span class="sc">:</span><span class="fu">I</span>(d)<span class="sc">+</span>(y_l1<span class="sc">+</span>y_l2)<span class="sc">:</span><span class="fu">I</span>(<span class="dv">1</span><span class="sc">-</span>d),<span class="at">data=</span>dt)</span>
<span id="cb114-4"><a href="tutorial-8-threshold-autoregression.html#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(tar)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = y ~ (y_l1 + y_l2):I(d) + (y_l1 + y_l2):I(1 - d), 
##     data = dt)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -2.97704 -0.60528 -0.02506  0.61754  2.66733 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   -0.01380    0.07519  -0.183 0.854535    
## y_l1:I(d)      0.97060    0.06283  15.449  &lt; 2e-16 ***
## y_l2:I(d)      0.00998    0.06160   0.162 0.871403    
## y_l1:I(1 - d)  1.24182    0.10229  12.140  &lt; 2e-16 ***
## y_l2:I(1 - d) -0.34188    0.10158  -3.366 0.000848 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.9586 on 351 degrees of freedom
## Multiple R-squared:  0.916,  Adjusted R-squared:  0.9151 
## F-statistic: 957.5 on 4 and 351 DF,  p-value: &lt; 2.2e-16</code></pre>
<p>Generate a sequence of one-step-ahead forecasts from TAR(2) using the rolling window scheme, where the first rolling window ranges from period 1 to period 240. For comparison, also generate the one-step-ahead forecasts from the AR(2) and the random walk models. Calculate the RMSFE measures for the three models.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb116-1"><a href="tutorial-8-threshold-autoregression.html#cb116-1" aria-hidden="true" tabindex="-1"></a>R <span class="ot">&lt;-</span> <span class="dv">240</span></span>
<span id="cb116-2"><a href="tutorial-8-threshold-autoregression.html#cb116-2" aria-hidden="true" tabindex="-1"></a>P <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dt)<span class="sc">-</span>R</span>
<span id="cb116-3"><a href="tutorial-8-threshold-autoregression.html#cb116-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-4"><a href="tutorial-8-threshold-autoregression.html#cb116-4" aria-hidden="true" tabindex="-1"></a>dt[,<span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">rw=</span><span class="fu">as.numeric</span>(<span class="cn">NA</span>),<span class="at">ar=</span><span class="fu">as.numeric</span>(<span class="cn">NA</span>),<span class="at">tar=</span><span class="fu">as.numeric</span>(<span class="cn">NA</span>))]</span>
<span id="cb116-5"><a href="tutorial-8-threshold-autoregression.html#cb116-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-6"><a href="tutorial-8-threshold-autoregression.html#cb116-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>P){</span>
<span id="cb116-7"><a href="tutorial-8-threshold-autoregression.html#cb116-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-8"><a href="tutorial-8-threshold-autoregression.html#cb116-8" aria-hidden="true" tabindex="-1"></a>  ar <span class="ot">&lt;-</span> <span class="fu">lm</span>(y<span class="sc">~</span>y_l1<span class="sc">+</span>y_l2,<span class="at">data=</span>dt[i<span class="sc">:</span>(R<span class="dv">-1</span><span class="sc">+</span>i)])</span>
<span id="cb116-9"><a href="tutorial-8-threshold-autoregression.html#cb116-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-10"><a href="tutorial-8-threshold-autoregression.html#cb116-10" aria-hidden="true" tabindex="-1"></a>  tar <span class="ot">&lt;-</span> <span class="fu">lm</span>(y<span class="sc">~</span>(y_l1<span class="sc">+</span>y_l2)<span class="sc">:</span><span class="fu">I</span>(d)<span class="sc">+</span>(y_l1<span class="sc">+</span>y_l2)<span class="sc">:</span><span class="fu">I</span>(<span class="dv">1</span><span class="sc">-</span>d),<span class="at">data=</span>dt[i<span class="sc">:</span>(R<span class="dv">-1</span><span class="sc">+</span>i)])</span>
<span id="cb116-11"><a href="tutorial-8-threshold-autoregression.html#cb116-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-12"><a href="tutorial-8-threshold-autoregression.html#cb116-12" aria-hidden="true" tabindex="-1"></a>  dt<span class="sc">$</span>rw[R<span class="sc">+</span>i] <span class="ot">&lt;-</span> dt<span class="sc">$</span>y[R<span class="dv">-1</span><span class="sc">+</span>i]</span>
<span id="cb116-13"><a href="tutorial-8-threshold-autoregression.html#cb116-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-14"><a href="tutorial-8-threshold-autoregression.html#cb116-14" aria-hidden="true" tabindex="-1"></a>  dt<span class="sc">$</span>ar[R<span class="sc">+</span>i] <span class="ot">&lt;-</span> ar<span class="sc">$</span>coefficients[<span class="dv">1</span>]<span class="sc">+</span>ar<span class="sc">$</span>coefficients[<span class="dv">2</span>]<span class="sc">*</span>dt<span class="sc">$</span>y[R<span class="dv">-1</span><span class="sc">+</span>i]<span class="sc">+</span>ar<span class="sc">$</span>coefficients[<span class="dv">3</span>]<span class="sc">*</span>dt<span class="sc">$</span>y[R<span class="dv">-2</span><span class="sc">+</span>i]</span>
<span id="cb116-15"><a href="tutorial-8-threshold-autoregression.html#cb116-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-16"><a href="tutorial-8-threshold-autoregression.html#cb116-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(dt<span class="sc">$</span>y[R<span class="dv">-1</span><span class="sc">+</span>i]<span class="sc">&gt;=</span><span class="dv">0</span>){</span>
<span id="cb116-17"><a href="tutorial-8-threshold-autoregression.html#cb116-17" aria-hidden="true" tabindex="-1"></a>    dt<span class="sc">$</span>tar[R<span class="sc">+</span>i] <span class="ot">&lt;-</span> tar<span class="sc">$</span>coefficients[<span class="dv">1</span>]<span class="sc">+</span>tar<span class="sc">$</span>coefficients[<span class="dv">2</span>]<span class="sc">*</span>dt<span class="sc">$</span>y[R<span class="dv">-1</span><span class="sc">+</span>i]<span class="sc">+</span>tar<span class="sc">$</span>coefficients[<span class="dv">3</span>]<span class="sc">*</span>dt<span class="sc">$</span>y[R<span class="dv">-2</span><span class="sc">+</span>i]</span>
<span id="cb116-18"><a href="tutorial-8-threshold-autoregression.html#cb116-18" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb116-19"><a href="tutorial-8-threshold-autoregression.html#cb116-19" aria-hidden="true" tabindex="-1"></a>    dt<span class="sc">$</span>tar[R<span class="sc">+</span>i] <span class="ot">&lt;-</span> tar<span class="sc">$</span>coefficients[<span class="dv">1</span>]<span class="sc">+</span>tar<span class="sc">$</span>coefficients[<span class="dv">4</span>]<span class="sc">*</span>dt<span class="sc">$</span>y[R<span class="dv">-1</span><span class="sc">+</span>i]<span class="sc">+</span>tar<span class="sc">$</span>coefficients[<span class="dv">5</span>]<span class="sc">*</span>dt<span class="sc">$</span>y[R<span class="dv">-2</span><span class="sc">+</span>i]</span>
<span id="cb116-20"><a href="tutorial-8-threshold-autoregression.html#cb116-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb116-21"><a href="tutorial-8-threshold-autoregression.html#cb116-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb116-22"><a href="tutorial-8-threshold-autoregression.html#cb116-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb116-23"><a href="tutorial-8-threshold-autoregression.html#cb116-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-24"><a href="tutorial-8-threshold-autoregression.html#cb116-24" aria-hidden="true" tabindex="-1"></a>dt[,<span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">rw_e=</span>y<span class="sc">-</span>rw,<span class="at">ar_e=</span>y<span class="sc">-</span>ar,<span class="at">tar_e=</span>y<span class="sc">-</span>tar)]</span>
<span id="cb116-25"><a href="tutorial-8-threshold-autoregression.html#cb116-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-26"><a href="tutorial-8-threshold-autoregression.html#cb116-26" aria-hidden="true" tabindex="-1"></a>rmsfe_rw <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>(dt<span class="sc">$</span>rw_e<span class="sc">^</span><span class="dv">2</span>,<span class="at">na.rm=</span>T))</span>
<span id="cb116-27"><a href="tutorial-8-threshold-autoregression.html#cb116-27" aria-hidden="true" tabindex="-1"></a>rmsfe_ar <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>(dt<span class="sc">$</span>ar_e<span class="sc">^</span><span class="dv">2</span>,<span class="at">na.rm=</span>T))</span>
<span id="cb116-28"><a href="tutorial-8-threshold-autoregression.html#cb116-28" aria-hidden="true" tabindex="-1"></a>rmsfe_tar <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>(dt<span class="sc">$</span>tar_e<span class="sc">^</span><span class="dv">2</span>,<span class="at">na.rm=</span>T))</span>
<span id="cb116-29"><a href="tutorial-8-threshold-autoregression.html#cb116-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-30"><a href="tutorial-8-threshold-autoregression.html#cb116-30" aria-hidden="true" tabindex="-1"></a>rmsfe_rw</span></code></pre></div>
<pre><code>## [1] 0.9258102</code></pre>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="tutorial-8-threshold-autoregression.html#cb118-1" aria-hidden="true" tabindex="-1"></a>rmsfe_ar</span></code></pre></div>
<pre><code>## [1] 0.9811523</code></pre>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="tutorial-8-threshold-autoregression.html#cb120-1" aria-hidden="true" tabindex="-1"></a>rmsfe_tar</span></code></pre></div>
<pre><code>## [1] 0.9996084</code></pre>
<p>Obtain the multi-step-ahead forecasts from period 241 onward using the so-called ‘skeleton extrapolation’ method (which yields biased forecasts) and the bootstrap resampling method (a numerical method that yields valid multi-step-ahead forecasts from nonlinear models). Plot the two forecasts along with the time series.</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="tutorial-8-threshold-autoregression.html#cb122-1" aria-hidden="true" tabindex="-1"></a>dt[,<span class="st">`</span><span class="at">:=</span><span class="st">`</span>(<span class="at">tar_skeleton=</span>y)]</span>
<span id="cb122-2"><a href="tutorial-8-threshold-autoregression.html#cb122-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-3"><a href="tutorial-8-threshold-autoregression.html#cb122-3" aria-hidden="true" tabindex="-1"></a>tar <span class="ot">&lt;-</span> <span class="fu">lm</span>(y<span class="sc">~</span>(y_l1<span class="sc">+</span>y_l2)<span class="sc">:</span><span class="fu">I</span>(d)<span class="sc">+</span>(y_l1<span class="sc">+</span>y_l2)<span class="sc">:</span><span class="fu">I</span>(<span class="dv">1</span><span class="sc">-</span>d),<span class="at">data=</span>dt[<span class="dv">1</span><span class="sc">:</span>R])</span>
<span id="cb122-4"><a href="tutorial-8-threshold-autoregression.html#cb122-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-5"><a href="tutorial-8-threshold-autoregression.html#cb122-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>P){</span>
<span id="cb122-6"><a href="tutorial-8-threshold-autoregression.html#cb122-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb122-7"><a href="tutorial-8-threshold-autoregression.html#cb122-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(dt<span class="sc">$</span>tar_skeleton[R<span class="dv">-1</span><span class="sc">+</span>i]<span class="sc">&gt;=</span><span class="dv">0</span>){</span>
<span id="cb122-8"><a href="tutorial-8-threshold-autoregression.html#cb122-8" aria-hidden="true" tabindex="-1"></a>    dt<span class="sc">$</span>tar_skeleton[R<span class="sc">+</span>i] <span class="ot">&lt;-</span> tar<span class="sc">$</span>coefficients[<span class="dv">1</span>]<span class="sc">+</span>tar<span class="sc">$</span>coefficients[<span class="dv">2</span>]<span class="sc">*</span>dt<span class="sc">$</span>tar_skeleton[R<span class="dv">-1</span><span class="sc">+</span>i]<span class="sc">+</span>tar<span class="sc">$</span>coefficients[<span class="dv">3</span>]<span class="sc">*</span>dt<span class="sc">$</span>tar_skeleton[R<span class="dv">-2</span><span class="sc">+</span>i]</span>
<span id="cb122-9"><a href="tutorial-8-threshold-autoregression.html#cb122-9" aria-hidden="true" tabindex="-1"></a>  }<span class="cf">else</span>{</span>
<span id="cb122-10"><a href="tutorial-8-threshold-autoregression.html#cb122-10" aria-hidden="true" tabindex="-1"></a>    dt<span class="sc">$</span>tar_skeleton[R<span class="sc">+</span>i] <span class="ot">&lt;-</span> tar<span class="sc">$</span>coefficients[<span class="dv">1</span>]<span class="sc">+</span>tar<span class="sc">$</span>coefficients[<span class="dv">4</span>]<span class="sc">*</span>dt<span class="sc">$</span>tar_skeleton[R<span class="dv">-1</span><span class="sc">+</span>i]<span class="sc">+</span>tar<span class="sc">$</span>coefficients[<span class="dv">5</span>]<span class="sc">*</span>dt<span class="sc">$</span>tar_skeleton[R<span class="dv">-2</span><span class="sc">+</span>i]</span>
<span id="cb122-11"><a href="tutorial-8-threshold-autoregression.html#cb122-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb122-12"><a href="tutorial-8-threshold-autoregression.html#cb122-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb122-13"><a href="tutorial-8-threshold-autoregression.html#cb122-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb122-14"><a href="tutorial-8-threshold-autoregression.html#cb122-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-15"><a href="tutorial-8-threshold-autoregression.html#cb122-15" aria-hidden="true" tabindex="-1"></a>dt[<span class="dv">1</span><span class="sc">:</span>R]<span class="sc">$</span>tar_skeleton <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb122-16"><a href="tutorial-8-threshold-autoregression.html#cb122-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-17"><a href="tutorial-8-threshold-autoregression.html#cb122-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-18"><a href="tutorial-8-threshold-autoregression.html#cb122-18" aria-hidden="true" tabindex="-1"></a>B <span class="ot">&lt;-</span> <span class="dv">5000</span> <span class="co"># the number of bootstrap simulations</span></span>
<span id="cb122-19"><a href="tutorial-8-threshold-autoregression.html#cb122-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-20"><a href="tutorial-8-threshold-autoregression.html#cb122-20" aria-hidden="true" tabindex="-1"></a>boot_mat <span class="ot">&lt;-</span> <span class="fu">replicate</span>(B,dt<span class="sc">$</span>y)</span>
<span id="cb122-21"><a href="tutorial-8-threshold-autoregression.html#cb122-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-22"><a href="tutorial-8-threshold-autoregression.html#cb122-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>B){</span>
<span id="cb122-23"><a href="tutorial-8-threshold-autoregression.html#cb122-23" aria-hidden="true" tabindex="-1"></a>  eps <span class="ot">&lt;-</span> <span class="fu">sample</span>(tar<span class="sc">$</span>residuals,P,<span class="at">replace=</span>T)</span>
<span id="cb122-24"><a href="tutorial-8-threshold-autoregression.html#cb122-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb122-25"><a href="tutorial-8-threshold-autoregression.html#cb122-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>P){</span>
<span id="cb122-26"><a href="tutorial-8-threshold-autoregression.html#cb122-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb122-27"><a href="tutorial-8-threshold-autoregression.html#cb122-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(boot_mat[R<span class="dv">-1</span><span class="sc">+</span>i,b]<span class="sc">&gt;=</span><span class="dv">0</span>){</span>
<span id="cb122-28"><a href="tutorial-8-threshold-autoregression.html#cb122-28" aria-hidden="true" tabindex="-1"></a>      boot_mat[R<span class="sc">+</span>i,b] <span class="ot">&lt;-</span> tar<span class="sc">$</span>coefficients[<span class="dv">1</span>]<span class="sc">+</span>tar<span class="sc">$</span>coefficients[<span class="dv">2</span>]<span class="sc">*</span>boot_mat[R<span class="dv">-1</span><span class="sc">+</span>i,b]<span class="sc">+</span>tar<span class="sc">$</span>coefficients[<span class="dv">3</span>]<span class="sc">*</span>boot_mat[R<span class="dv">-2</span><span class="sc">+</span>i,b]<span class="sc">+</span>eps[i]</span>
<span id="cb122-29"><a href="tutorial-8-threshold-autoregression.html#cb122-29" aria-hidden="true" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb122-30"><a href="tutorial-8-threshold-autoregression.html#cb122-30" aria-hidden="true" tabindex="-1"></a>      boot_mat[R<span class="sc">+</span>i,b] <span class="ot">&lt;-</span> tar<span class="sc">$</span>coefficients[<span class="dv">1</span>]<span class="sc">+</span>tar<span class="sc">$</span>coefficients[<span class="dv">4</span>]<span class="sc">*</span>boot_mat[R<span class="dv">-1</span><span class="sc">+</span>i,b]<span class="sc">+</span>tar<span class="sc">$</span>coefficients[<span class="dv">5</span>]<span class="sc">*</span>boot_mat[R<span class="dv">-2</span><span class="sc">+</span>i,b]<span class="sc">+</span>eps[i]</span>
<span id="cb122-31"><a href="tutorial-8-threshold-autoregression.html#cb122-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb122-32"><a href="tutorial-8-threshold-autoregression.html#cb122-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb122-33"><a href="tutorial-8-threshold-autoregression.html#cb122-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb122-34"><a href="tutorial-8-threshold-autoregression.html#cb122-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb122-35"><a href="tutorial-8-threshold-autoregression.html#cb122-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb122-36"><a href="tutorial-8-threshold-autoregression.html#cb122-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-37"><a href="tutorial-8-threshold-autoregression.html#cb122-37" aria-hidden="true" tabindex="-1"></a>dt<span class="sc">$</span>tar_boot <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(boot_mat)</span>
<span id="cb122-38"><a href="tutorial-8-threshold-autoregression.html#cb122-38" aria-hidden="true" tabindex="-1"></a>dt[<span class="dv">1</span><span class="sc">:</span>R]<span class="sc">$</span>tar_boot <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb122-39"><a href="tutorial-8-threshold-autoregression.html#cb122-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-40"><a href="tutorial-8-threshold-autoregression.html#cb122-40" aria-hidden="true" tabindex="-1"></a>sub_lg <span class="ot">&lt;-</span> <span class="fu">melt</span>(dt[,.(date,y,tar_skeleton,tar_boot)],<span class="at">id.vars=</span><span class="st">"date"</span>)</span>
<span id="cb122-41"><a href="tutorial-8-threshold-autoregression.html#cb122-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-42"><a href="tutorial-8-threshold-autoregression.html#cb122-42" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(sub_lg,<span class="fu">aes</span>(<span class="at">x=</span>date,<span class="at">y=</span>value,<span class="at">color=</span>variable,<span class="at">linetype=</span>variable))<span class="sc">+</span></span>
<span id="cb122-43"><a href="tutorial-8-threshold-autoregression.html#cb122-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">size=</span><span class="dv">1</span>,<span class="at">na.rm=</span>T)<span class="sc">+</span></span>
<span id="cb122-44"><a href="tutorial-8-threshold-autoregression.html#cb122-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="st">"darkgray"</span>,<span class="st">"indianred"</span>,<span class="st">"steelblue"</span>))<span class="sc">+</span></span>
<span id="cb122-45"><a href="tutorial-8-threshold-autoregression.html#cb122-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>))<span class="sc">+</span></span>
<span id="cb122-46"><a href="tutorial-8-threshold-autoregression.html#cb122-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">"Year"</span>,<span class="at">y=</span><span class="st">"Series"</span>)<span class="sc">+</span></span>
<span id="cb122-47"><a href="tutorial-8-threshold-autoregression.html#cb122-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()<span class="sc">+</span></span>
<span id="cb122-48"><a href="tutorial-8-threshold-autoregression.html#cb122-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position=</span><span class="st">"top"</span>,<span class="at">legend.title=</span><span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="forecasting_files/figure-html/unnamed-chunk-83-1.png" width="624"></p>

</div>
<p style="text-align: center;">
<a href="tutorial-7-dynamic-factor-models.html"><button class="btn btn-default">Previous</button></a>
<a href="tutorial-9-forecast-evaluation.html"><button class="btn btn-default">Next</button></a>
</p>
<p class="build-date">Page built: 
2022-08-28
 using 
R version 4.1.2 (2021-11-01)
</p>
</div>
</div>



</body>
</html>
